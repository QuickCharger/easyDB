<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>EasyDB</title>
  <script src="jquery.min.js"></script>

  <script src="/react.production.min.js"></script>
  <script src="/react-dom.production.min.js"></script>

  <!-- Don't use this in production: -->
  <script src="/babel.min.js"></script>

  <script src="/moment.js"></script>
  <script src="/dayjs.min.js"></script>
  <script src="/antd.min.js"></script>
  <link href='/reset.min.css'>

  <script>
    function Post (path = '/', obj) {
      return new Promise((resolve, reject) => {
        if (path[0] !== '/')
          path = '/' + path
        console.log(`request for ${path}. obj ${JSON.stringify(obj) || JSON.stringify({})}`)
        $.ajax({
          type: 'POST',
          url: `${path}`,
          dataType: 'json',
          data: obj,
          success: function (res) {
            console.log(`get     for ${path}. rcv ${JSON.stringify(res)}`)
            Number(res.status) === 1 ? resolve(res) : resolve(res)
          },
          fail: function (xhr, ajaxOptions, thrownError) {
            reject(false)
          },
        })
      })
    }
  </script>

  <script type="text/babel">
    function MyApp () {
      // 数据
      const PageList = [
        { Name: '主页', JumpTo: '/', Module: <PageHome /> },
        { Name: '表操作', JumpTo: '/db', Module: <PageDB /> },
        { Name: 'todo', JumpTo: '/todo', Module: <div>todo</div> },
      ]
      // 导航
      let [curPath, setCurPath] = React.useState('/db')
      // 当前选定DB
      let [curDB, setCurDB] = React.useState('')
      // 当前选定table
      let [curTable, setCurTable] = React.useState('')
      // 选定的table的内容
      let [curTableContent, setCurTableContent] = React.useState([])
      // 选定的table的desc的footer
      let [curDescFooter, setCurDescFooter] = React.useState({})

      // 数据库的brief
      let [brief, setBrief] = React.useState([])

      const [messageApi, contextHolder] = antd.message.useMessage()

      let PostBrief = async () => {
        let r = await Post('/_easydb/brief')
        // 如果只有一个DB 则默认选中此DB
        if (r.data.length === 1) {
          setCurDB(r.data[0].dbName)
          // 如果只有一个tabel 则默认选中此table
          if (r.data[0].tables.length === 1) {
            setCurTable(r.data[0].tables[0].TableName)
          }
        }
        setBrief(r.data)
      }
      let PostIndex = async () => {
        if (curTable.length === 0)
          return
        let r = await Post(`/${curTable}/index`)
        setCurTableContent(r.data.list)
      }
      // 数据初始化
      React.useEffect(() => {
        (async () => {
          await PostBrief()
        })()
      }, [])

      // 表内容初始化
      React.useEffect(() => {
        PostIndex()
      }, [curTable])

      // 导航栏
      let Navi = () => {
        return <div className="navLink">
          {PageList.map((it, idx) => <a
            key={idx}
            className={curPath === it.JumpTo ? 'curHightLight' : ''}
            onClick={() => { setCurPath(it.JumpTo) }}
          > {it.Name}</a>)}
        </div>
      }

      function Page () {
        let m = PageList.find(it => it.JumpTo === curPath)
        return m ? m.Module : <h1>page not found</h1>
      }
      function PageHome () {
        return <>
          <h1>this is a home page</h1>
        </>
      }
      function PageDB () {
        let getAllDB = () => {
          let ret = []
          for (let db of brief) {
            ret.push({ dbName: db.dbName, key: db.dbName })
          }
          return ret
        }
        let getAllTables = () => {
          let ret = []
          if (brief.length === 0)
            return ret
          let db = brief.find(it => it.dbName === curDB)
          if (db === undefined)
            return ret
          for (let it of db.tables)
            ret.push({ tableName: it.TableName, key: it.TableName })
          return ret
        }
        // 表内容的header
        let getTableHeader = () => {
          let ret = []
          let db = brief.find(it => it.dbName === curDB)
          if (db === undefined)
            return ret
          let table = db.tables.find(it => it.TableName === curTable)
          if (table === undefined)
            return ret
          ret.push({
            title: 'Id',
            dataIndex: 'Id',
            key: 'Id',
          })
          for (let it of table.Column) {
            ret.push({
              title: it.Name,
              dataIndex: it.Name,
              key: it.Name,
            })
          }
          ret.push(
            {
              title: '',
              key: 'operation',
              fixed: 'right',
              width: 100,
              render: (v) => <antd.Button
                danger
                onClick={async () => {
                  let r = await Post(`/${curTable}/destroy`, { Ids: [v.Id] })
                  if (r.code !== 0) {
                    antd.message.error('err message')
                  } else {
                    antd.message.success('destroy message')
                    await PostIndex()
                  }

                }}
              >DEL</antd.Button>,
            },)
          return ret
        }
        let getTableContent = () => {
          let ret = []
          for (let it of curTableContent) {
            ret.push({ key: it.Id, ...it })
          }
          return ret
        }
        let getDescHeader = () => {
          let ret = []
          let db = brief.find(it => it.dbName === curDB)
          if (db === undefined)
            return ret
          let table = db.tables.find(it => it.TableName === curTable)
          if (table === undefined || table.Column.length === 0)
            return ret
          // 假设以[0]的数据作为基准
          for (let key in table.Column[0]) {
            ret.push({
              title: key,
              dataIndex: key,
              key,
            })
          }
          return ret
        }
        let getDescContent = () => {
          let ret = []
          let db = brief.find(it => it.dbName === curDB)
          if (db === undefined)
            return ret
          let table = db.tables.find(it => it.TableName === curTable)
          if (table === undefined || table.Column.length === 0)
            return ret
          ret = table.Column
          return ret
        }
        let modDB = () => {
          return <div className='border' style={{ width: '20%', height: '100%', padding: '0.5em' }}>
            <antd.Table columns={
              [{
                title: '',
                dataIndex: 'dbName',
                key: 'dbName',
                render: (text) => <a onClick={() => { setCurDB(text) }}>{text}</a>,
              },]
            } dataSource={getAllDB()} />
          </div>
        }
        let modTable = () => {
          return <div className='border' style={{ width: '20%', height: '100%', padding: '0.5em' }}>
            <antd.Button type="primary">add TABLE todo</antd.Button>
            <antd.Table
              pagination={false}
              columns={
                [{
                  title: '',
                  dataIndex: 'tableName',
                  key: 'tableName',
                  render: (text) => <a onClick={() => { setCurTable(text) }}>{text}</a>,
                },]
              }
              dataSource={getAllTables()} />
          </div>
        }
        let modData = () => {
          // return <div className='border' style={{ width: '100%', height: '70%' }}> </div>
          return <antd.Table style={{ width: '100%', height: '70%' }}
            size='middle'
            footer={() =>
              <antd.Form
                layout='inline'
                onFinish={''}
              >
                <antd.Form.Item label="新增字段名称" name='Name' required>
                  <antd.Input placeholder="name" />
                </antd.Form.Item>
              </antd.Form>
            }
            columns={getTableHeader()}
            dataSource={getTableContent()} />
        }
        let modDesc = () => {
          // return <div className='border' style={{ width: '100%', height: '30%' }}>Desc</div>
          return <antd.Table style={{ width: '100%', height: '30%' }}
            size='small'
            columns={getDescHeader()}
            dataSource={getDescContent()}
            footer={() =>
              <antd.Form
                layout='inline'
                onFinish={async (vs) => {
                  let r = await Post('/_easydb/update', {
                    TableName: curTable,
                    Column: [vs]
                  })
                  if (r.code !== 0) {
                    antd.message.error('err message')
                  } else {
                    antd.message.success('success message')
                    await PostBrief()
                  }
                }}
              >
                <antd.Form.Item label="新增字段名称" name='Name' required>
                  <antd.Input placeholder="name" />
                </antd.Form.Item>
                <antd.Form.Item label="类型" name='Type' required>
                  <antd.Select style={{ width: '150px' }}>
                    <antd.Select.Option value="int" default>int</antd.Select.Option>
                    <antd.Select.Option value="varchar(255)">varchar(255)</antd.Select.Option>
                    <antd.Select.Option value="text">text</antd.Select.Option>
                    <antd.Select.Option value="timestamp">timestamp</antd.Select.Option>
                  </antd.Select>
                </antd.Form.Item>
                <antd.Form.Item>
                  <antd.Button type="primary" htmlType="submit">新增</antd.Button>
                </antd.Form.Item>
              </antd.Form>
            }
          />
        }
        return <div style={{ display: 'flex', flexDirection: 'row', height: '80vh' }}>
          {modDB()}
          {modTable()}
          <div style={{
            display: 'flex',
            flexDirection: 'column',
            // alignItems: 'center',
            // justifyContent: 'center',
            width: '60%',
          }}>
            {modData()}
            {modDesc()}
          </div>
        </div>
      }
      return <>
        <Navi />
        <Page />
      </>
    }

    const container = document.getElementById('root')
    const root = ReactDOM.createRoot(container)
    root.render(<MyApp />);

  </script>

  <style>
    * {
      box-sizing: border-box;
    }

    .border {
      border: 1px solid black;
    }

    li {
      user-select: none;
    }

    li:nth-child(even) {
      background-color: white;
    }

    li:nth-child(odd) {
      background-color: rgb(236, 236, 236);
    }

    body {
      background-color: white;
    }

    .navHead {
      background-color: white;
      text-align: center;
      padding: 2em;
    }

    .navLink {
      background-color: #333;
      margin-bottom: 1em;
      margin-left: 1em;
      margin-right: 1em;
    }

    .navLink a {
      display: inline-block;
      padding: 1em;
      color: white;
    }

    .navLink a:last-child {
      position: absolute;
      right: 1em;
    }

    .navLink a:hover {
      background-color: white;
      color: black;
    }

    .navLink .curHightLight {
      background-color: rgb(225, 171, 144);
      color: black;
    }

    .main {
      display: inline-block;
      width: 74%;
      vertical-align: top;
    }
  </style>
</head>

<body>
  <div id="root">empty</div>
  <!--
      Note: this page is a great way to try React but it's not suitable for production.
      It slowly compiles JSX with Babel in the browser and uses a large development build of React.

      Read this page for starting a new React project with JSX:
      https://react.dev/learn/start-a-new-react-project

      Read this page for adding React with JSX to an existing project:
      https://react.dev/learn/add-react-to-an-existing-project
    -->
</body>

</html>