<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>EasyDB</title>
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Don't use this in production: -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/dayjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/antd/5.6.4/antd.min.js"></script>
  <link href='https://cdnjs.cloudflare.com/ajax/libs/antd/5.6.4/reset.min.css'>


  <script>
    function Post (path = '/', obj) {
      return new Promise((resolve, reject) => {
        if (path[0] !== '/')
          path = '/' + path
        console.log(`request for ${path}. obj ${JSON.stringify(obj) || JSON.stringify({})}`)
        $.ajax({
          type: 'POST',
          url: `${path}`,
          dataType: 'json',
          data: obj,
          success: function (res) {
            console.log(`get     for ${path}. rcv ${JSON.stringify(res)}`)
            Number(res.status) === 1 ? resolve(res) : resolve(res)
          },
          fail: function (xhr, ajaxOptions, thrownError) {
            reject(false)
          },
        })
      })
    }
  </script>

  <script type="text/babel">
    function MyApp () {
      // 数据
      const PageList = [
        { Name: '主页', JumpTo: '/', Module: <PageHome /> },
        { Name: '表操作', JumpTo: '/db', Module: <PageDB /> },
        { Name: 'todo', JumpTo: '/todo', Module: <div>todo</div> },
      ]
      let [curPath, setCurPath] = React.useState('/db')
      let [curDB, setCurDB] = React.useState('')
      let [curTable, setCurTable] = React.useState('')
      let [curTableContent, setCurTableContent] = React.useState([])
      let [brief, setBrief] = React.useState([])

      // 数据初始化
      React.useEffect(() => {
        (async () => {
          let r = await Post('/_easydb/brief')
          // 如果只有一个DB 则默认选中此DB
          if (r.data.length === 1) {
            setCurDB(r.data[0].dbName)
          }
          setBrief(r.data)
        })()
      }, [])

      // 表内容初始化
      React.useEffect(() => {
        if (curTable.length === 0)
          return
        (async () => {
          let r = await Post(`/${curTable}/index`)
          console.log(r)
        })()
      }, [curTable])

      // 导航栏
      let Navi = () => {
        return <div className="navLink">
          {PageList.map((it, idx) => <a
            key={idx}
            className={curPath === it.JumpTo ? 'curHightLight' : ''}
            onClick={() => { setCurPath(it.JumpTo) }}
          > {it.Name}</a>)}
        </div>
      }

      function Page () {
        let m = PageList.find(it => it.JumpTo === curPath)
        return m ? m.Module : <h1>page not found</h1>
      }
      function PageHome () {
        return <>
          <h1>this is a home page</h1>
        </>
      }
      function PageDB () {
        let getAllDB = () => {
          let ret = []
          for (let db of brief) {
            ret.push({ dbName: db.dbName, key: db.dbName })
          }
          return ret
        }
        let getAllTables = () => {
          let ret = []
          if (brief.length === 0)
            return ret
          let db = brief.find(it => it.dbName === curDB)
          if (db === undefined)
            return ret
          for (let it of db.tables)
            ret.push({ tableName: it.TableName, key: it.TableName })
          return ret
        }
        // 表内容的header
        let getTableHeader = () => {
          let ret = []
          let db = brief.find(it => it.dbName === curDB)
          if (db === undefined)
            return ret
          console.log(db)
          console.log(`curTabel`, curTable)
          let table = db.tables.find(it => it.TableName === curTable)
          console.log(table)
          if (table === undefined)
            return ret
          ret.push({
            title: 'Id',
            dataIndex: 'Id',
            key: 'Id',
          })
          for (let it of table.Column) {
            ret.push({
              title: it.Name,
              dataIndex: it.Name,
              key: it.Name,
            })
          }
          return ret
        }
        let getTableContent = async () => {
          let ret = curTableContent
          return ret
        }
        let modDB = () => {
          return <div className='border' style={{ width: '20%', height: '100%', padding: '0.5em' }}>
            <antd.Button type="primary">add DB todo</antd.Button>
            <antd.Table columns={
              [{
                title: '',
                dataIndex: 'dbName',
                key: 'dbName',
                render: (text) => <a onClick={() => { setCurDB(text) }}>{text}</a>,
              },]
            } dataSource={getAllDB()} />
          </div>
        }
        let modTable = () => {
          return <div className='border' style={{ width: '20%', height: '100%', padding: '0.5em' }}>
            <antd.Button type="primary">add TABLE todo</antd.Button>
            <antd.Table columns={
              [{
                title: '',
                dataIndex: 'tableName',
                key: 'tableName',
                render: (text) => <a onClick={() => { setCurTable(text) }}>{text}</a>,
              },]
            } dataSource={getAllTables()} />
          </div>
        }
        let modData = () => {
          // return <div className='border' style={{ width: '100%', height: '70%' }}> </div>
          return <antd.Table style={{ width: '100%', height: '70%' }} columns={getTableHeader()} dataSource={getAllTables()} />
        }
        let modDesc = () => {
          return <div className='border' style={{ width: '100%', height: '30%' }}>Desc</div>
        }
        return <div style={{ display: 'flex', flexDirection: 'row', height: '80vh' }}>
          {modDB()}
          {modTable()}
          <div style={{
            display: 'flex',
            flexDirection: 'column',
            // alignItems: 'center',
            // justifyContent: 'center',
            width: '60%',
          }}>
            {modData()}
            {modDesc()}
          </div>
        </div>
      }
      return <>
        <Navi />
        <Page />
      </>
    }

    const container = document.getElementById('root')
    const root = ReactDOM.createRoot(container)
    root.render(<MyApp />);

  </script>

  <style>
    * {
      box-sizing: border-box;
    }

    .border {
      border: 1px solid black;
    }

    li {
      user-select: none;
    }

    li:nth-child(even) {
      background-color: white;
    }

    li:nth-child(odd) {
      background-color: rgb(236, 236, 236);
    }

    body {
      background-color: white;
    }

    .navHead {
      background-color: white;
      text-align: center;
      padding: 2em;
    }

    .navLink {
      background-color: #333;
      margin-bottom: 1em;
      margin-left: 1em;
      margin-right: 1em;
    }

    .navLink a {
      display: inline-block;
      padding: 1em;
      color: white;
    }

    .navLink a:last-child {
      position: absolute;
      right: 1em;
    }

    .navLink a:hover {
      background-color: white;
      color: black;
    }

    .navLink .curHightLight {
      background-color: rgb(225, 171, 144);
      color: black;
    }

    .main {
      display: inline-block;
      width: 74%;
      vertical-align: top;
    }
  </style>
</head>

<body>
  <div id="root">empty</div>
  <!--
      Note: this page is a great way to try React but it's not suitable for production.
      It slowly compiles JSX with Babel in the browser and uses a large development build of React.

      Read this page for starting a new React project with JSX:
      https://react.dev/learn/start-a-new-react-project

      Read this page for adding React with JSX to an existing project:
      https://react.dev/learn/add-react-to-an-existing-project
    -->
</body>

</html>